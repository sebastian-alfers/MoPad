<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: socket.js</title>
    
    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">
    
    <h1 class="page-title">Source: socket.js</h1>
    
    


    
    <section>
        <article>
            <pre class="prettyprint source"><code>/**
 *
 * Controller-side socket-handling
 *
 * @class
 * 
 * @author Jonas Hartweg
 *
 */

window.connectionId = null;
window.failedConnectionTrials = 0;

window.Socket = {

	/**
	 * Socket initialization
	 *
	 * @constructor
	 */

	init : function(ip) {

		// Try to get the IP
		if (ip == null) {
			ip = 'localhost';
		}

		if (!("WebSocket" in window)) {
			console.log("Websockets not supported");
		} else {
			console.log('Trying to connect to websocket at ' + ip)

			try {

				window.mySocket = new WebSocket('ws://' + ip + ':8081/');
				console.log(mySocket.readyState);

				mySocket.onopen = function() {

					window.failedConnectionTrials = 0;
					console.log('Websocket: Status ' + mySocket.readyState + ' (open)');

					this.send(JSON.stringify({
						type : 'identify',
						connectionType : 'controller',
						data : {
							publicKey : '123456'
						}
					}));
					console.log('Sent identify msg');
				}

				mySocket.onmessage = function(msg) {

					var json = JSON.parse(msg.data);
					console.log(json);

					if (json.type == 'cacheConnectionIdOnController' && true) {
						connectionId = json.pin;
						//TODO Pin?
						// Load specified controller
						switch(json.controllerType) {
							case "joystick" :
								new Joystick();
								break;
							case "joypad" :
								new Joypad();
								break;
							case "benchmark" :
								new Benchmark();
								break;
							default :
								console.log("Unkown controllerType");
						}
					} else if (json.type == 'wrongPin') {
						alert('Wrong pin!');
						// TODO integrate into UI
						$('#pinInput').val('');
					} else if (json.type == 'lostGameConnection') {
						$('#.helpOverlay').remove();
						$('#controller').append('&lt;div class="helpOverlay">Lost connection to the game &lt;a onclick="resetController()">ok&lt;/a>&lt;/div>');
						// TODO implement on server side
					}

				}

				mySocket.onerror = function(msg) {
					console.log('WebSocket error', msg);
				}

				mySocket.onclose = function(msg) {
					window.failedConnectionTrials++;
					console.log('WebSocket connection closed');

					if (failedConnectionTrials &lt; 5) {
						window.socket = Socket.init(ip);
						// Reconnect
					} else {
						$('body').html('Can\'t connect to WebSocket server - Please reload! Sorry :(');
					}
				}
			} catch (exception) {
				console.log("WebSocket error " + expection);
			}

		}

		return this;
	},

	/**
	 * Send data via the socket
	 */
	
	send : function(data) {

		if (data == "" || data == undefined) {
			console.log('Websocket: No data set');
			return;
		}

		if (data.type == "" || data.type == undefined) {
			console.log('Websocket: no type set for web socket message');
			return;
		}

		try {
			mySocket.send(JSON.stringify(data));
			console.log('Websocket: Sent ')
			console.log(data);
		} catch (exception) {
			console.log('Websocket: Error ' + exception);
		}
	}
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Classes</h3><ul><li><a href="window.connectionId.html">connectionId</a></li><li><a href="window.Socket.init.html">init</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.1.0</a> on Mon Feb 11 2013 20:06:41 GMT+0100 (MEZ)
</footer>

<script> prettyPrint(); </script>
</body>
</html>
